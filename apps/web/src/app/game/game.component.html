<ng-container *ngIf="(state$|async) as state; else loading">
  <ng-container *ngIf="(playerId$|async) as pid">

    <div class="gamePage">
      <div class="gameBoard">

        <!-- Left column: room + status + log -->
        <aside class="sideCol">
          <div class="panel">
            <div class="label">Sala</div>
            <div class="roomCode" style="margin-top:6px">{{ state.roomCode }}</div>
            <div class="hint" style="margin-top:8px">
              T√∫: <b>{{ playerName(state, pid) }}</b>
              <span class="badge" style="margin-left:8px" [class.good]="state.turnPlayerId===pid" [class.bad]="state.turnPlayerId!==pid">
                {{ state.status === 'PLAYING' ? (state.turnPlayerId===pid ? 'tu turno' : 'esperando') : state.status }}
              </span>
            </div>

            <div class="hr"></div>
            <div class="row" style="justify-content:space-between">
              <button class="btn" (click)="backToLobby()">Salir</button>
              <button class="btn primary" (click)="startGame()" [disabled]="!canStart(state, pid)">Iniciar (host)</button>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <div class="panelTitle">Estado</div>
            <div class="kv" style="margin-top:10px">
              <div class="k">Contrato</div>
              <div class="v">#{{ state.contractIndex + 1 }}/{{ state.contractsTotal }} ‚Ä¢ {{ contractText(state) }}</div>

              <div class="k">Fase</div>
              <div class="v"><b>{{ phaseLabel(state.phase) }}</b></div>

              <div class="k">Turno</div>
              <div class="v">{{ state.turnPlayerId===pid ? 'T√∫' : playerName(state, state.turnPlayerId) }}</div>
            </div>
            <div class="hint" style="margin-top:10px">{{ contractHint(state, pid) }}</div>

            <div class="hr" *ngIf="state.roundWinnerId"></div>
            <div class="hint" *ngIf="state.roundWinnerId">√öltima ronda: gan√≥ <b>{{ playerName(state, state.roundWinnerId) }}</b></div>
          </div>

          <details class="panel" style="margin-top:12px">
            <summary class="panelTitle" style="cursor:pointer">Log</summary>
            <div class="log" style="margin-top:10px">
              <div *ngFor="let line of (log$|async)">{{ line }}</div>
            </div>
          </details>
        </aside>

        <!-- Main column: hud + table + your hand/builder -->
        <section class="mainCol">

          <div class="panel hudBar">
            <div class="hudPiles">
              <div class="hudPile">
                <div class="label">Mazo</div>
                <div class="pileCard clickable" [class.disabled]="!canDraw(state, pid)" (click)="drawDeck()">üÇ†</div>
                <div class="hint">{{ state.deckCount }} cartas</div>
              </div>

              <div class="hudPile"
                   cdkDropList
                   id="{{discardDropId}}"
                   [cdkDropListConnectedTo]="allDropIds()"
                   [cdkDropListDisabled]="!canDropToDiscard(state, pid)"
                   (cdkDropListDropped)="onDropToDiscard($event, state, pid)">
                <div class="label">Descarte</div>
                <div class="pileCard clickable"
                     [class.disabled]="!canDrawDiscard(state, pid)"
                     (click)="drawDiscard()">
                  {{ state.topDiscard ? cardShort(state.topDiscard) : '‚Äî' }}
                </div>
                <div class="hint">
                  <ng-container *ngIf="canDrawDiscard(state, pid)">click para robar</ng-container>
                  <ng-container *ngIf="!canDrawDiscard(state, pid)">en Botar: arrastra aqu√≠</ng-container>
                </div>
              </div>
            </div>

            <div class="hudCenter">
              <div class="label">Contrato activo</div>
              <div class="hudValue">#{{ state.contractIndex + 1 }}/{{ state.contractsTotal }} ‚Ä¢ {{ contractText(state) }}</div>
              <div class="hint" style="margin-top:4px">Jugador activo: <b>{{ state.turnPlayerId===pid ? 'T√∫' : playerName(state, state.turnPlayerId) }}</b></div>
            </div>

            <div class="hudRight">
              <div class="label">Jugadores</div>
              <div class="playersRow" style="margin-top:6px">
                <div class="playerPill" *ngFor="let p of state.players" [class.me]="p.id===pid" [class.turn]="p.id===state.turnPlayerId">
                  <span class="dot" [class.on]="p.connected"></span>
                  <span class="name">{{ p.name }}</span>
                  <span class="tag" *ngIf="p.id===state.hostPlayerId">host</span>
                  <span class="tag" *ngIf="p.id===state.turnPlayerId && state.status==='PLAYING'">turno</span>
                  <span class="count" title="Cartas en mano">{{ state.handsCount[p.id] ?? 0 }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="panel tablePanel">
            <div class="panelTitle">Mesa</div>
            <div class="panelSubtitle">Los juegos bajados quedan aqu√≠. Para botar cartas: arrastra una carta a un juego (solo cuando est√© habilitado).</div>

            <div class="tablePlayers">
              <div class="tableCol" *ngFor="let p of state.players" [class.turn]="p.id===state.turnPlayerId" [class.me]="p.id===pid">
                <div class="tableColHead">
                  <div class="row" style="justify-content:space-between; width:100%">
                    <div class="row" style="gap:8px">
                      <span class="name" style="font-weight:900">{{ p.name }}</span>
                      <span class="badge" [class.good]="state.hasLaidDown[p.id]" [class.bad]="!state.hasLaidDown[p.id]">
                        {{ state.hasLaidDown[p.id] ? 'baj√≥' : 'no baj√≥' }}
                      </span>
                    </div>
                    <span class="count" title="Puntos">{{ state.scores[p.id] ?? 0 }}p</span>
                  </div>
                </div>

                <ng-container *ngIf="(state.table[p.id]?.length ?? 0) > 0; else noMelds">
                  <div class="tableMeld"
                       *ngFor="let m of state.table[p.id]"
                       cdkDropList
                       id="{{tableDropId(p.id, m.id)}}"
                       [cdkDropListConnectedTo]="allDropIds()"
                       [cdkDropListDisabled]="!canDropToTableMeld(state, pid, p.id)"
                       (cdkDropListDropped)="onDropToTableMeld($event, state, pid, p.id, m.id)"
                       [class.dropEnabled]="canDropToTableMeld(state, pid, p.id)">
                    <div class="tableMeldTop">
                      <span class="badge">{{ m.type === 'SET' ? 'TR√çO' : 'ESCALA' }}</span>
                      <span class="hint" style="color:var(--text)">{{ m.cards.length }} carta(s)</span>
                    </div>
                    <div class="meldCards">
                      <span class="cardChip" *ngFor="let c of m.cards" [class.joker]="c.isJoker">
                        <ng-container *ngIf="c.isJoker; else normalTc">
                          <span class="jokerIconSm">üÉè</span>
                        </ng-container>
                        <ng-template #normalTc>{{ cardShort(c) }}</ng-template>
                      </span>
                    </div>
                  </div>
                </ng-container>

                <ng-template #noMelds>
                  <div class="hint" style="margin-top:10px">Sin melds</div>
                </ng-template>
              </div>
            </div>
          </div>

          <div class="panel playerPanel">
            <div class="playerPanelTop">
              <div>
                <div class="panelTitle">Tus cartas</div>
                <div class="panelSubtitle">Armar: crea un juego y arrastra cartas. Botar: arrastra una carta al descarte o selecci√≥nala y usa ‚ÄúBotar‚Äù.</div>
              </div>

              <div class="row" style="gap:8px; align-items:flex-end">
                <div class="label" style="margin-right:6px">Orden</div>
                <button class="btn" (click)="setSort('RANK')" [class.primary]="sortMode==='RANK'">Valor (A alto)</button>
                <button class="btn" (click)="setSort('SUIT')" [class.primary]="sortMode==='SUIT'">Pinta</button>
              </div>
            </div>

            <div class="playerGrid">
              <div class="builderArea">
                <div class="builderHead">
                  <div class="label">Melds pendientes</div>
                  <div class="row" style="gap:8px">
                    <button class="btn warn" (click)="addPending('SET')" [disabled]="!canBuild(state, pid)">+ Tr√≠o</button>
                    <button class="btn warn" (click)="addPending('RUN')" [disabled]="!canBuild(state, pid)">+ Escala</button>
                    <button class="btn" (click)="clearBuilder()" [disabled]="pendingMelds.length===0">Limpiar</button>
                  </div>
                </div>

                <div class="builderEmpty" *ngIf="pendingMelds.length===0">
                  <div class="hint">Crea un Tr√≠o/Escala y arrastra cartas desde tu mano. (Las cartas puestas aqu√≠ se quitan de tu mano hasta que limpies o bajes).</div>
                </div>

                <div class="builderList" *ngIf="pendingMelds.length>0">
                  <div class="builderItem" *ngFor="let m of pendingMelds; let i = index">
                    <div class="builderItemTop">
                      <div class="row" style="gap:8px">
                        <span class="badge">{{ meldLabel(m) }}</span>
                        <span class="hint" style="color:var(--text)">{{ m.cardIds.length }} carta(s)</span>
                      </div>
                      <button class="btn" (click)="removePending(i)">Quitar</button>
                    </div>

                    <div class="dropZone"
                         cdkDropList
                         id="{{pendingDropId(m)}}"
                         [cdkDropListConnectedTo]="allDropIds()"
                         [cdkDropListDisabled]="!canDropToPending(state, pid)"
                         (cdkDropListDropped)="onDropToPending($event, state, pid, m)">
                      <div class="hint" *ngIf="m.cardIds.length===0">Arrastra cartas aqu√≠</div>
                      <div class="meldCards" *ngIf="m.cardIds.length>0">
                        <div class="cardChip draggableChip"
                             *ngFor="let c of pendingCards(m)"
                             cdkDrag
                             [cdkDragData]="c"
                             (cdkDragStarted)="dragStarted()"
                             (cdkDragEnded)="dragEnded()"
                             [class.joker]="c.isJoker">
                          <ng-container *ngIf="c.isJoker; else normalPc">
                            <span class="jokerIconSm">üÉè</span>
                          </ng-container>
                          <ng-template #normalPc>{{ cardShort(c) }}</ng-template>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="handArea"
                   cdkDropList
                   id="{{handDropId}}"
                   [cdkDropListConnectedTo]="allDropIds()"
                   [cdkDropListDisabled]="!canDropToHand(state, pid)"
                   (cdkDropListDropped)="onDropToHand($event, state, pid)">
                <div class="handBig" *ngIf="(hand$|async) as hand">
                  <div class="cardTile"
                       *ngFor="let c of visibleHand(hand)"
                       cdkDrag
                       [cdkDragData]="c"
                       (cdkDragStarted)="dragStarted()"
                       (cdkDragEnded)="dragEnded()"
                       (click)="onCardClick($event, state, pid, c)"
                       [class.joker]="c.isJoker"
                       [class.newCard]="c.id===recentlyDrawnId"
                       [class.sel]="c.id===discardSelectedId">
                    <ng-container *ngIf="c.isJoker; else normalHc">
                      <span class="jokerIcon">üÉè</span>
                    </ng-container>
                    <ng-template #normalHc>{{ cardShort(c) }}</ng-template>
                  </div>
                </div>
                <div class="hint" style="margin-top:8px">Tip: arrastra una carta desde aqu√≠ a un juego en la mesa (cuando est√© habilitado) o al descarte (en Botar).</div>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px" *ngIf="(rejected$|async) as rej">
            <div class="panelTitle">Acci√≥n rechazada</div>
            <div class="panelSubtitle">{{ rej.message ?? rej.reason }}</div>
          </div>

        </section>
      </div>

      <div class="actionBar">
        <!-- DRAW -->
        <button class="btn primary" (click)="drawDeck()" [disabled]="!canDraw(state, pid)">1) Robar mazo</button>
        <button class="btn" (click)="drawDiscard()" [disabled]="!canDrawDiscard(state, pid)">1) Robar descarte</button>

        <!-- MELD -->
        <button class="btn warn" (click)="addPending('SET')" [disabled]="!canBuild(state, pid)">2) Nuevo tr√≠o</button>
        <button class="btn warn" (click)="addPending('RUN')" [disabled]="!canBuild(state, pid)">2) Nueva escala</button>
        <button class="btn primary" (click)="laydown()" [disabled]="!canLaydown(state, pid)">2) Bajar contrato</button>
        <button class="btn primary" (click)="extraMeld()" [disabled]="!canExtraMeld(state, pid)">2) Bajar juego</button>
        <button class="btn" (click)="endMeld()" [disabled]="!canEndMeld(state, pid)">2) Terminar</button>

        <!-- DISCARD -->
        <button class="btn danger" (click)="discardSelected()" [disabled]="!canDiscardPhase(state, pid) || !discardSelectedId">3) Botar</button>
      </div>
    </div>

  </ng-container>
</ng-container>

<ng-template #loading>
  <div class="page pageCenter">
    <div class="panel">
      <div class="panelTitle">Cargando‚Ä¶</div>
      <div class="panelSubtitle">Si no est√°s en una sala, vuelve al lobby.</div>
      <div class="hr"></div>
      <button class="btn" (click)="backToLobby()">Ir al lobby</button>
    </div>
  </div>
</ng-template>
